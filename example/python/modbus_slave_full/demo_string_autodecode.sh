#!/bin/bash
# 字符串自动解码功能演示

BASE_URL="http://localhost:8080"

echo "=============================================================="
echo "📝 字符串自动解码功能演示"
echo "=============================================================="
echo ""

# 准备测试数据
echo "【准备阶段】写入测试数据"
echo "--------------------------------------------------------------"

# 1. 写入设备名称
curl -s -X POST "$BASE_URL/api/write/string" \
  -H "Content-Type: application/json" \
  -d '{"slave_id": 1, "address": 10, "text": "PLC-001"}' > /dev/null
echo "✓ 地址 10-13: 设备名称 'PLC-001'"

# 2. 写入版本号
curl -s -X POST "$BASE_URL/api/write/string" \
  -H "Content-Type: application/json" \
  -d '{"slave_id": 1, "address": 20, "text": "v2.5.1"}' > /dev/null
echo "✓ 地址 20-23: 版本号 'v2.5.1'"

# 3. 写入状态消息
curl -s -X POST "$BASE_URL/api/write/string" \
  -H "Content-Type: application/json" \
  -d '{"slave_id": 1, "address": 30, "text": "RUNNING"}' > /dev/null
echo "✓ 地址 30-33: 状态 'RUNNING'"

# 4. 写入纯数值数据
for i in {0..4}; do
  addr=$((40 + i))
  value=$((i * 100 + 500))
  curl -s -X POST "$BASE_URL/api/write/register" \
    -H "Content-Type: application/json" \
    -d "{\"slave_id\": 1, \"address\": $addr, \"value\": $value}" > /dev/null
done
echo "✓ 地址 40-44: 纯数值数据 [500, 600, 700, 800, 900]"

# 5. 写入混合数据
curl -s -X POST "$BASE_URL/api/write/string" \
  -H "Content-Type: application/json" \
  -d '{"slave_id": 1, "address": 50, "text": "Temp:25C"}' > /dev/null
echo "✓ 地址 50-54: 温度信息 'Temp:25C'"

echo ""
echo "【测试演示】在Web界面中测试"
echo "--------------------------------------------------------------"
echo ""
echo "请在浏览器中访问: http://localhost:8080"
echo "切换到 '📁 文件记录' 标签"
echo ""
echo "使用 'FC20 读取文件记录' 进行以下测试："
echo ""
echo "┌─────────────────────────────────────────────────────────┐"
echo "│ 测试 1: 读取设备名称                                    │"
echo "├─────────────────────────────────────────────────────────┤"
echo "│ 记录号: 10                                              │"
echo "│ 长度:   4                                               │"
echo "│ 预期结果: 显示数值 + 自动解码为 'PLC-001'              │"
echo "└─────────────────────────────────────────────────────────┘"
echo ""
echo "┌─────────────────────────────────────────────────────────┐"
echo "│ 测试 2: 读取版本号                                      │"
echo "├─────────────────────────────────────────────────────────┤"
echo "│ 记录号: 20                                              │"
echo "│ 长度:   4                                               │"
echo "│ 预期结果: 显示数值 + 自动解码为 'v2.5.1'               │"
echo "└─────────────────────────────────────────────────────────┘"
echo ""
echo "┌─────────────────────────────────────────────────────────┐"
echo "│ 测试 3: 读取状态                                        │"
echo "├─────────────────────────────────────────────────────────┤"
echo "│ 记录号: 30                                              │"
echo "│ 长度:   4                                               │"
echo "│ 预期结果: 显示数值 + 自动解码为 'RUNNING'              │"
echo "└─────────────────────────────────────────────────────────┘"
echo ""
echo "┌─────────────────────────────────────────────────────────┐"
echo "│ 测试 4: 读取纯数值                                      │"
echo "├─────────────────────────────────────────────────────────┤"
echo "│ 记录号: 40                                              │"
echo "│ 长度:   5                                               │"
echo "│ 预期结果: 只显示数值（不会显示字符串解码）             │"
echo "└─────────────────────────────────────────────────────────┘"
echo ""
echo "┌─────────────────────────────────────────────────────────┐"
echo "│ 测试 5: 读取混合数据                                    │"
echo "├─────────────────────────────────────────────────────────┤"
echo "│ 记录号: 50                                              │"
echo "│ 长度:   5                                               │"
echo "│ 预期结果: 显示数值 + 自动解码为 'Temp:25C'             │"
echo "└─────────────────────────────────────────────────────────┘"
echo ""
echo "=============================================================="
echo "💡 功能特性："
echo "=============================================================="
echo ""
echo "✅ 自动检测: 读取时自动判断是否包含可打印字符"
echo "✅ 智能解码: 如果是字符串，自动显示解码结果"
echo "✅ 双重显示: 同时显示数值和字符串，便于调试"
echo "✅ 兼容模式: 纯数值数据不会显示字符串解码"
echo "✅ 十六进制: 字符串模式下显示十六进制编码"
echo ""
echo "🎯 使用场景："
echo "   • 设备标识符 (Device ID, Serial Number)"
echo "   • 版本信息 (Firmware Version)"
echo "   • 状态消息 (Status Message)"
echo "   • 配置参数 (Config String)"
echo "   • 日志信息 (Log Entry)"
echo ""
echo "=============================================================="

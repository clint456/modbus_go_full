### 项目背景

这是一个功能完整的 **Modbus TCP/RTU 服务器**项目，使用 Python 实现，支持：
- Modbus TCP 协议（端口 5020）
- Modbus RTU 串口协议
- 完整的功能码支持（01-21，包括文件记录 FC20/21）
- 数据持久化（JSON 导入/导出）
- Web 控制台界面（HTTP 端口 8080）
- 实时日志监控
- 手动修改寄存器/线圈数据

**项目依赖管理：使用 Poetry**

### 代码改进目标

请对 `modbus_server_full_featured.py` 进行以下优化和增强：

#### 0. **项目结构和依赖管理（使用 Poetry）**

**必须使用 Poetry 管理项目依赖和虚拟环境。**

##### 项目结构
```
modbus_server/
├── pyproject.toml              # Poetry 配置文件
├── poetry. lock                 # 依赖锁定文件
├── README.md                   # 项目文档
├── config.example.yaml         # 配置文件示例
├── config.yaml                 # 实际配置文件（git ignore）
├── modbus_data.json           # 数据文件（git ignore）
├── modbus_server/             # 主包目录
│   ├── __init__.py
│   ├── __main__.py            # 入口点
│   ├── config.py              # 配置管理
│   ├── datastore.py           # 数据存储类
│   ├── protocol/              # 协议处理
│   │   ├── __init__.py
│   │   ├── handlers.py        # 功能码处理器
│   │   ├── tcp. py             # TCP 服务器
│   │   ├── rtu.py             # RTU 服务器
│   │   └── utils.py           # CRC、帧解析等工具
│   ├── web/                   # Web 控制台
│   │   ├── __init__.py
│   │   ├── server.py          # HTTP/WebSocket 服务器
│   │   ├── api.py             # API 路由
│   │   └── static/            # 前端资源
│   │       ├── index.html
│   │       ├── app.js
│   │       └── style.css
│   └── utils/                 # 工具模块
│       ├── __init__.py
│       ├── logger.py          # 日志管理
│       └── history.py         # 历史记录
├── tests/                     # 测试目录
│   ├── __init__.py
│   ├── test_protocol.py
│   ├── test_datastore.py
│   └── test_web.py
└── docs/                      # 文档目录
    ├── installation.md
    ├── configuration.md
    └── api.md
```

##### pyproject.toml 要求

创建 `pyproject.toml` 文件，包含以下内容：

```toml
[tool.poetry]
name = "modbus-server"
version = "1.0.0"
description = "功能完整的 Modbus TCP/RTU 服务器，支持 Web 控制台"
authors = ["Your Name <your.email@example.com>"]
readme = "README.md"
license = "MIT"
keywords = ["modbus", "tcp", "rtu", "server", "automation"]
classifiers = [
    "Development Status :: 4 - Beta",
    "Intended Audience :: Developers",
    "Topic :: System :: Hardware",
    "License :: OSI Approved :: MIT License",
    "Programming Language :: Python :: 3.8",
    "Programming Language :: Python :: 3.9",
    "Programming Language :: Python :: 3.10",
    "Programming Language :: Python ::  3.11",
]

[tool.poetry.dependencies]
python = "^3.8"
aiohttp = "^3.9. 0"
pyserial-asyncio = "^0.6"
pyyaml = "^6.0"
aiohttp-cors = "^0.7. 0"

[tool.poetry.group.dev.dependencies]
pytest = "^7.4.0"
pytest-asyncio = "^0.21.0"
pytest-cov = "^4.1.0"
black = "^23.0.0"
flake8 = "^6.0.0"
mypy = "^1.5.0"
isort = "^5.12.0"

[tool.poetry.scripts]
modbus-server = "modbus_server.__main__:main"

[build-system]
requires = ["poetry-core"]
build-backend = "poetry. core.masonry.api"

[tool.black]
line-length = 100
target-version = ['py38']

[tool.isort]
profile = "black"
line_length = 100

[tool.mypy]
python_version = "3.8"
warn_return_any = true
warn_unused_configs = true
disallow_untyped_defs = true

[tool.pytest.ini_options]
asyncio_mode = "auto"
testpaths = ["tests"]
```

##### 安装和运行命令

**初始化项目：**
```bash
poetry install
```

**运行服务器：**
```bash
poetry run modbus-server
# 或者
poetry shell
modbus-server
```

**开发环境：**
```bash
poetry install --with dev
poetry run pytest
poetry run black . 
poetry run flake8
poetry run mypy modbus_server
```

---

#### 1. **代码质量改进**
- 重构代码结构为上述模块化目录结构
- 使用面向对象设计（OOP）
- 添加完整的类型提示（Type Hints），通过 mypy 检查
- 使用 Black 格式化代码
- 使用 isort 整理导入
- 改进错误处理和边界检查
- 添加完整的文档字符串（docstrings，Google 风格）

#### 2. **功能增强**
- **配置文件支持**：添加 YAML 配置文件（使用 PyYAML），支持配置：
  - TCP/RTU 端口和参数
  - 数据区大小（线圈、寄存器数量）
  - 日志级别和输出位置
  - Web 服务器端口和认证
  - 多从站 ID 配置
- **多从站 ID 支持**：支持配置和管理多个 Modbus Slave ID
- **实时数据变化推送**：Web 界面使用 WebSocket 实时推送数据变化
- **数据变化历史记录**：记录所有写操作的历史（时间戳、地址、旧值、新值、来源）
- **访问控制**：Web 界面添加基本的用户认证（用户名/密码，使用 aiohttp-session）

#### 3. **RTU 协议完善**
- 完善 Modbus RTU 的 CRC16 校验（独立函数，带测试）
- 改进 RTU 帧的解析逻辑，支持所有功能码的正确帧长度计算
- 添加 RTU 超时和错误帧处理
- 支持配置串口参数（波特率、数据位、停止位、校验位）

#### 4. **Web 界面增强**
- 使用现代 JavaScript（ES6+）优化 UI
- 添加数据可视化图表（使用 Chart.js）
- 添加功能码统计（各功能码的调用次数和成功率）
- 支持分页查看大量数据（虚拟滚动）
- 添加导出日志到文件的功能
- 添加暗黑模式切换
- 使用 WebSocket 替代轮询

#### 5. **测试和文档**
- 添加单元测试（使用 pytest 和 pytest-asyncio）
- 添加集成测试（测试 TCP/RTU 协议交互）
- 测试覆盖率要求 > 80%（使用 pytest-cov）
- 创建详细的 README.md：
  - 快速开始（使用 Poetry）
  - 功能特性列表
  - 安装说明（Poetry install）
  - 使用示例
  - API 文档
  - 配置说明
  - 故障排除
- 添加 docs/ 目录详细文档
- 添加 Dockerfile 和 docker-compose.yml

#### 6. **性能和可靠性**
- 添加并发连接限制和连接池管理
- 实现请求频率限制（使用 aiohttp 中间件）
- 添加内存使用监控
- 优化大数据量时的性能
- 添加优雅关闭机制（SIGTERM 处理）
- 添加健康检查端点（/health）

#### 7. **扩展功能**
- 支持 Modbus 网关模式（作为主站转发请求到其他从站）
- 添加数据模拟器（自动生成变化的数据，用于测试）
- 支持自定义功能码处理（插件机制）
- 添加 Prometheus metrics 导出

### 技术要求

- **依赖管理：必须使用 Poetry**
- Python 3.8+ 兼容性
- 使用 asyncio 异步编程
- 遵循 PEP 8 代码规范（使用 Black、isort）
- 使用现代 Python 特性（dataclass、pathlib、typing）
- 保持向后兼容（现有数据文件格式）
- 所有公共 API 必须有类型提示
- 通过 mypy 静态类型检查

### 配置文件示例（config.yaml）

```yaml
# Modbus Server Configuration

server:
  tcp: 
    enabled: true
    host: "0.0.0.0"
    port: 5020
  rtu:
    enabled: false
    port: "/dev/ttyUSB0"
    baudrate: 9600
    bytesize: 8
    parity: "N"
    stopbits: 1
    timeout: 1.0

slaves:
  - id: 1
    name: "主设备"
    coils:  100
    discrete_inputs: 100
    holding_registers: 100
    input_registers: 100

web:
  enabled: true
  host: "0.0.0.0"
  port: 8080
  auth:
    enabled: true
    username: "admin"
    password: "admin123"  # 应使用哈希存储

data: 
  auto_save: true
  save_interval: 60  # 秒
  data_file: "modbus_data.json"
  history_enabled: true
  history_max_size: 1000

logging:
  level: "INFO"  # DEBUG, INFO, WARNING, ERROR
  file: "modbus_server.log"
  max_size: 10485760  # 10MB
  backup_count: 5
```

### 优先级

**P0（必须）**：
- Poetry 项目结构搭建
- 代码重构为模块化
- 配置文件支持
- 完善 RTU 协议
- 基本测试覆盖

**P1（重要）**：
- WebSocket 推送
- 历史记录功能
- Web 认证
- 完整文档
- Docker 支持

**P2（可选）**：
- 数据可视化
- 网关模式
- Prometheus metrics
- 插件系统

### 现有代码位置

- 主程序：`modbus_server_full_featured.py`（需要重构到新结构）
- 数据文件：`modbus_data.json`（自动生成）

### 期望输出

1. **完整的 Poetry 项目结构**（如上所示）
2. **pyproject.toml** 配置文件
3. **模块化的代码**（多文件组织）
4. **配置文件系统**（config.yaml + 示例）
5. **完整的测试套件**（pytest）
6. **详细的文档**（README + docs/）
7. **Docker 支持**（Dockerfile + docker-compose. yml）
8. **CI/CD 配置**（可选：GitHub Actions）

### 开发工作流

```bash
# 1. 初始化项目
poetry install

# 2. 激活虚拟环境
poetry shell

# 3. 运行开发服务器
modbus-server --config config.yaml

# 4. 运行测试
poetry run pytest -v --cov=modbus_server

# 5. 代码格式化
poetry run black modbus_server tests
poetry run isort modbus_server tests

# 6. 类型检查
poetry run mypy modbus_server

# 7. 构建分发包
poetry build

# 8. 发布（可选）
poetry publish
```

### Docker 使用

```dockerfile
# Dockerfile
FROM python:3.11-slim

# 安装 Poetry
RUN pip install poetry

WORKDIR /app

# 复制依赖文件
COPY pyproject.toml poetry.lock ./

# 安装依赖（不包括开发依赖）
RUN poetry config virtualenvs.create false \
    && poetry install --no-dev --no-interaction --no-ansi

# 复制项目代码
COPY modbus_server ./modbus_server
COPY config.example.yaml ./config.yaml

EXPOSE 5020 8080

CMD ["poetry", "run", "modbus-server"]
```

```yaml
# docker-compose.yml
version: '3.8'

services:
  modbus-server:
    build: .
    ports:
      - "5020:5020"
      - "8080:8080"
    volumes:
      - ./config.yaml:/app/config.yaml
      - ./modbus_data.json:/app/modbus_data.json
    restart: unless-stopped
```

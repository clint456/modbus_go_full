# 📁 文件记录寄存器可视化界面 - 使用指南

## 🎯 功能概述

新增的**文件记录**标签页提供了一个直观的界面，用于操作和理解 Modbus 文件记录功能（FC20/FC21）。

## 🌟 界面特性

### 左侧操作面板

#### 1. 📖 读取文件记录 (FC20)
- **从站 ID**: 选择目标从站（1-247）
- **文件编号**: 文件逻辑分组编号（0-9）
- **记录编号**: 映射到保持寄存器的起始地址
- **记录长度**: 要读取的寄存器数量（1-100）

#### 2. ✍️ 写入文件记录 (FC21)  
- **从站 ID**: 选择目标从站
- **文件编号**: 文件逻辑分组编号
- **记录编号**: 映射到保持寄存器的起始地址
- **数据值**: 要写入的值，用逗号分隔（例: 100,200,300）

#### 3. 📊 操作结果
实时显示操作状态和结果，包括：
- 成功/失败状态
- 操作参数
- 映射的寄存器范围
- 实际数据值

### 右侧可视化面板

#### 1. 🗺️ 文件记录映射图
三层可视化展示文件记录的工作流程：

**第一层 - 文件记录请求**
```
📁 文件记录参数
├─ 文件编号: 0
├─ 记录编号: 50  
└─ 记录长度: 5
```

**第二层 - 寄存器映射**
```
📊 保持寄存器
├─ 起始地址: 50
└─ 结束地址: 54
```

**第三层 - 数据内容**
```
📦 寄存器数据
[11] [22] [33] [44] [55]
```

#### 2. 💡 工作原理说明
详细解释文件记录的工作机制和使用场景。

## 📝 使用步骤

### 场景 1: 写入文件记录

1. **切换到文件记录标签页**
   - 点击导航栏的 "📁 文件记录" 按钮

2. **填写写入参数**
   - 从站 ID: `1`
   - 文件编号: `0`
   - 记录编号: `50`
   - 数据值: `100,200,300,400,500`

3. **点击写入按钮**
   - 点击 "💾 写入" 按钮
   - 观察操作结果区域的反馈

4. **查看可视化效果**
   - 右侧面板实时显示映射关系
   - 数据网格以动画方式展示写入的值
   - 每个数据格显示地址和值

### 场景 2: 读取文件记录

1. **填写读取参数**
   - 从站 ID: `1`
   - 文件编号: `0`
   - 记录编号: `50`
   - 记录长度: `5`

2. **点击读取按钮**
   - 点击 "🔍 读取" 按钮
   - 等待读取完成

3. **查看读取结果**
   - 操作结果区域显示读取的数据
   - 可视化面板更新显示读取的值
   - 数据格会有高亮动画效果

## 🎨 界面元素说明

### 状态指示

- ✅ **绿色背景**: 操作成功
- ❌ **红色背景**: 操作失败  
- ⏳ **灰色文字**: 操作进行中

### 颜色编码

- 🔵 **蓝色边框**: 文件记录参数框
- 🟢 **绿色边框**: 寄存器映射框
- 🟡 **黄色边框**: 数据内容框

### 动画效果

- **弹跳箭头**: 指示数据流向
- **脉冲动画**: 新写入的数据格高亮
- **平滑过渡**: 所有状态变化都有动画

## 💻 API 集成示例

### 使用 Web API 操作文件记录

```bash
# 写入文件记录（映射到保持寄存器 50-54）
for i in {0..4}; do
  addr=$((50 + i))
  value=$((100 * (i + 1)))
  curl -X POST http://localhost:8080/api/write-register \
    -H "Content-Type: application/json" \
    -d "{\"slave_id\": 1, \"address\": $addr, \"value\": $value}"
done

# 读取数据验证
curl http://localhost:8080/api/data?slave_id=1
```

### 使用测试客户端

```bash
cd /home/clint/Work/modbus_go_full/example/python/modbus_slave_full
poetry run python test_client.py
```

测试客户端会自动测试 FC20/FC21 功能并显示结果。

## 📊 实际应用场景

### 1. 配置文件管理
```
文件 0: 系统配置 (记录 0-99)
文件 1: 网络配置 (记录 100-199)
文件 2: 设备参数 (记录 200-299)
```

### 2. 批量数据传输
```
单次操作传输多个寄存器值
减少通信开销
提高效率
```

### 3. 结构化数据存储
```
每个文件记录代表一个数据结构
记录长度 = 结构体字段数量
便于管理和维护
```

## 🔍 工作原理详解

### 文件记录 → 保持寄存器映射

文件记录是保持寄存器的逻辑抽象层：

1. **文件编号 (File Number)**
   - 用于组织和分类
   - 不影响实际存储地址
   - 范围: 0-65535

2. **记录编号 (Record Number)**
   - 直接映射到保持寄存器地址
   - 记录编号 = 寄存器地址
   - 例: 记录 50 = 寄存器地址 50

3. **记录长度 (Record Length)**
   - 连续寄存器的数量
   - 范围: 1-120（Modbus 规范）
   - 例: 长度 5 = 5个连续寄存器

### 操作流程

**读取 (FC20)**:
```
1. 客户端请求: 文件0, 记录50, 长度5
2. 服务器解析: 读取寄存器 [50-54]
3. 返回数据: [v1, v2, v3, v4, v5]
4. 界面显示: 可视化数据和映射关系
```

**写入 (FC21)**:
```
1. 客户端请求: 文件0, 记录50, 数据[11,22,33,44,55]
2. 服务器解析: 写入寄存器 50=11, 51=22, ..., 54=55
3. 确认写入成功
4. 界面显示: 更新可视化显示
```

## 🎯 最佳实践

### 1. 参数选择
- **文件编号**: 用于逻辑分组，建议按功能分类
- **记录编号**: 选择不冲突的地址范围
- **记录长度**: 根据实际需求，不超过120

### 2. 数据组织
- 相关数据放在同一文件
- 预留扩展空间
- 文档化地址分配方案

### 3. 错误处理
- 检查地址范围是否有效
- 验证数据长度
- 处理超时和异常

## 🌐 浏览器支持

- ✅ Chrome/Edge 90+
- ✅ Firefox 88+
- ✅ Safari 14+
- ✅ 移动端自适应

## 📱 响应式设计

- **桌面**: 双栏布局（操作 + 可视化）
- **平板**: 双栏布局（自适应）
- **手机**: 单栏堆叠布局

## 🎨 主题支持

- ☀️ **明亮模式**: 默认主题
- 🌙 **暗黑模式**: 点击右上角切换
- 所有颜色自动适配当前主题

## 🚀 快速测试

1. **启动服务器**
   ```bash
   poetry run modbus-server
   ```

2. **访问界面**
   - 打开浏览器: http://localhost:8080
   - 点击 "📁 文件记录" 标签

3. **快速测试**
   - 写入: 文件0, 记录10, 数据 "10,20,30"
   - 读取: 文件0, 记录10, 长度3
   - 观察可视化效果

## 💡 提示

- 📌 操作后可在 "统计信息" 标签查看 FC20/FC21 调用次数
- 📌 操作结果会在 "历史记录" 标签中记录
- 📌 支持 WebSocket 实时更新
- 📌 所有操作都有动画反馈

## 🆘 故障排除

### 问题: 写入失败
- 检查从站 ID 是否正确（默认为1）
- 检查地址是否超出范围
- 查看服务器日志: `/tmp/modbus.log`

### 问题: 读取数据为0
- 确认之前是否写入过数据
- 检查记录编号是否匹配
- 尝试先写入再读取

### 问题: 界面无响应
- 刷新页面
- 检查服务器是否运行
- 查看浏览器控制台错误

## 📚 相关资源

- [README.md](README.md) - 项目总体说明
- [IMPLEMENTATION.md](IMPLEMENTATION.md) - 完整实现报告
- [test_client.py](test_client.py) - 完整功能测试客户端
- Modbus 规范: [Modbus Application Protocol V1.1b3]

---

**享受直观的文件记录操作体验！** 🎉
